# Vue SPA åˆ·æ–°ç™½å±é—®é¢˜è§£æä¸è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

åœ¨mallåå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åœ¨ç®¡ç†å‘˜ç®¡ç†ã€è§’è‰²ç®¡ç†ç­‰é¡µé¢åˆ·æ–°æµè§ˆå™¨æ—¶å¯èƒ½å‡ºç°ç™½å±ç°è±¡ã€‚è¿™æ˜¯Vueå•é¡µåº”ç”¨(SPA)ä¸­çš„å…¸å‹é—®é¢˜ã€‚

## é—®é¢˜åŸå› æ·±åº¦åˆ†æ

### 1. SPAè·¯ç”±æœºåˆ¶ä¸ä¼ ç»Ÿé¡µé¢çš„å·®å¼‚

#### ä¼ ç»Ÿå¤šé¡µåº”ç”¨ vs SPA
```
ä¼ ç»Ÿå¤šé¡µåº”ç”¨ï¼š
- æ¯ä¸ªURLå¯¹åº”æœåŠ¡å™¨ä¸Šçš„å®é™…æ–‡ä»¶
- /admin.html, /role.html ç­‰éƒ½æ˜¯çœŸå®å­˜åœ¨çš„æ–‡ä»¶
- æµè§ˆå™¨ç›´æ¥è¯·æ±‚å¯¹åº”çš„HTMLæ–‡ä»¶

SPAåº”ç”¨ï¼š
- æ‰€æœ‰è·¯ç”±éƒ½ç”±JavaScriptç®¡ç†
- æœåŠ¡å™¨åªæœ‰ä¸€ä¸ªå…¥å£æ–‡ä»¶ index.html
- è·¯ç”±åˆ‡æ¢é€šè¿‡History APIå®ç°ï¼Œä¸ä¼šå‘æœåŠ¡å™¨å‘è¯·æ±‚
```

#### é—®é¢˜å‘ç”Ÿçš„å…·ä½“åœºæ™¯
```
1. ç”¨æˆ·è®¿é—® http://localhost:8081/dashboard
   â†’ Viteå¼€å‘æœåŠ¡å™¨è¿”å› index.html
   â†’ Vue RouteråŠ è½½ï¼Œæ˜¾ç¤ºä»ªè¡¨ç›˜ç»„ä»¶

2. ç”¨æˆ·ç‚¹å‡»"ç®¡ç†å‘˜ç®¡ç†"é“¾æ¥ï¼ŒURLå˜ä¸º http://localhost:8081/system/admin
   â†’ è¿™æ˜¯é€šè¿‡History APIå®ç°çš„å‰ç«¯è·¯ç”±è·³è½¬
   â†’ ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚

3. ç”¨æˆ·åœ¨ /system/admin é¡µé¢æŒ‰F5åˆ·æ–°
   â†’ æµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚ http://localhost:8081/system/admin
   â†’ å¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ­£ç¡®é…ç½®ï¼Œä¼šæ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ä»¶
   â†’ è¿”å› 404 é”™è¯¯ï¼Œé¡µé¢ç™½å±
```

### 2. Viteå¼€å‘æœåŠ¡å™¨çš„é»˜è®¤è¡Œä¸º

**å¥½æ¶ˆæ¯ï¼šViteé»˜è®¤å·²ç»æ”¯æŒSPAè·¯ç”±å›é€€ï¼**

Viteå¼€å‘æœåŠ¡å™¨ä¼šè‡ªåŠ¨å¤„ç†ä»¥ä¸‹æƒ…å†µï¼š
- æ ¹è·¯å¾„ `/` â†’ è¿”å› `index.html`
- é™æ€èµ„æºè·¯å¾„ï¼ˆå¦‚ `/assets/*`ï¼‰â†’ è¿”å›å¯¹åº”æ–‡ä»¶
- APIä»£ç†è·¯å¾„ï¼ˆå¦‚ `/api/*`ï¼‰â†’ è½¬å‘åˆ°åç«¯æœåŠ¡å™¨
- **æ‰€æœ‰å…¶ä»–è·¯å¾„** â†’ è‡ªåŠ¨å›é€€åˆ° `index.html`ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰

### 3. å¯èƒ½çš„é—®é¢˜æ¥æº

å¦‚æœä»ç„¶å‡ºç°åˆ·æ–°ç™½å±é—®é¢˜ï¼Œé€šå¸¸æ˜¯ç”±ä»¥ä¸‹åŸå› é€ æˆçš„ï¼š

#### A. è·¯ç”±å®ˆå«ä¸­çš„å¼‚æ­¥åŠ è½½é—®é¢˜

```typescript
// è·¯ç”±å®ˆå«æ‰§è¡Œæµç¨‹
router.beforeEach(async (to, from, next) => {
  // 1. æ£€æŸ¥token
  if (token) {
    // 2. å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦é‡æ–°è·å–
    if (!authStore.userInfo) {
      // 3. å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
      await authStore.initAuth();
      await authStore.getUserPermissionsAction();
      
      // 4. åŠ¨æ€æ·»åŠ è·¯ç”±
      const accessRoutes = permissionStore.generateRoutes();
      accessRoutes.forEach(route => {
        router.addRoute(route);
      });
      
      // 5. å…³é”®é—®é¢˜ï¼šè·¯ç”±æ·»åŠ åçš„è·³è½¬å¤„ç†
      next(); // âŒ å¯èƒ½å¯¼è‡´è·¯ç”±æœªå®Œå…¨æ·»åŠ å°±è·³è½¬
    }
  }
});
```

#### B. æƒé™æ£€æŸ¥æˆ–APIè¯·æ±‚å¤±è´¥

```typescript
// åˆ·æ–°é¡µé¢æ—¶ï¼Œå¦‚æœæƒé™æ£€æŸ¥å¤±è´¥æˆ–APIè¯·æ±‚å¤±è´¥
// å¯èƒ½å¯¼è‡´è·¯ç”±å®ˆå«é˜»æ­¢é¡µé¢æ¸²æŸ“
if (!hasPermission) {
  next('/403'); // è¢«é‡å®šå‘åˆ°æ— æƒé™é¡µé¢
  return;
}
```

#### C. çŠ¶æ€ç®¡ç†é—®é¢˜

```typescript
// Pinia storeåœ¨é¡µé¢åˆ·æ–°åçŠ¶æ€ä¸¢å¤±
// å¦‚æœæ²¡æœ‰æ­£ç¡®æ¢å¤çŠ¶æ€ï¼Œå¯èƒ½å¯¼è‡´ç»„ä»¶æ¸²æŸ“å¤±è´¥
const authStore = useAuthStore();
if (!authStore.userInfo) {
  // éœ€è¦é‡æ–°åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
}
```

## Viteä¸­çš„æ­£ç¡®é…ç½®æ–¹æ³•

### 1. æ ‡å‡†çš„Viteé…ç½®ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰

```typescript
// vite.config.ts - æ­£ç¡®çš„é…ç½®
export default defineConfig(({ command, mode }) => {
  const env = loadEnv(mode, process.cwd(), '')
  
  return {
    plugins: [vue()],
    
    resolve: {
      alias: {
        '@': resolve(__dirname, 'src'),
      },
    },
    
    server: {
      port: 8081,
      host: true,
      open: true,
      // âœ… Viteé»˜è®¤å°±æ”¯æŒSPAè·¯ç”±å›é€€ï¼Œæ— éœ€é¢å¤–é…ç½®
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL || 'http://localhost:3000',
          changeOrigin: true,
        }
      }
    }
  }
})
```

**é‡è¦è¯´æ˜ï¼š** 
- âŒ ä¸è¦æ·»åŠ  `historyApiFallback: true`ï¼ˆè¿™æ˜¯Webpacké…ç½®ï¼Œä¸æ˜¯Viteé…ç½®ï¼‰
- âœ… Viteé»˜è®¤å°±æ”¯æŒSPAåº”ç”¨çš„è·¯ç”±å›é€€
- âœ… å½“è®¿é—®ä¸å­˜åœ¨çš„è·¯å¾„æ—¶ï¼ŒViteä¼šè‡ªåŠ¨è¿”å› `index.html`

### 2. Viteçš„SPAæ”¯æŒåŸç†

```mermaid
graph TD
    A[ç”¨æˆ·åˆ·æ–° /system/admin] --> B[æµè§ˆå™¨å‘ViteæœåŠ¡å™¨è¯·æ±‚]
    B --> C{Viteå†…ç½®æ£€æŸ¥}
    C -->|é™æ€èµ„æº| D[è¿”å›å¯¹åº”æ–‡ä»¶]
    C -->|APIè¯·æ±‚| E[ä»£ç†è½¬å‘åˆ°åç«¯]
    C -->|é¡µé¢è·¯ç”±| F[è‡ªåŠ¨è¿”å› index.html]
    F --> G[æµè§ˆå™¨åŠ è½½Vueåº”ç”¨]
    G --> H[Vue Routerå¤„ç† /system/admin]
    H --> I[æ¸²æŸ“ç®¡ç†å‘˜é¡µé¢ç»„ä»¶]
```

## è§£å†³åˆ·æ–°ç™½å±çš„æ­£ç¡®æ–¹æ³•

### 1. ä¼˜åŒ–è·¯ç”±å®ˆå«çš„å¼‚æ­¥å¤„ç†

#### ä¿®å¤è·¯ç”±å®ˆå«ä¸­çš„å¼‚æ­¥é—®é¢˜

```typescript
// âœ… æ­£ç¡®çš„è·¯ç”±å®ˆå«å¤„ç†
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore();
  const permissionStore = usePermissionStore();
  
  // è·å–token
  const token = authStore.token;
  
  if (token) {
    if (to.path === '/login') {
      next('/dashboard');
      return;
    }
    
    // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‡æ–°è·å–
    if (!authStore.userInfo) {
      try {
        // é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
        await authStore.initAuth();
        await authStore.getUserPermissionsAction();
        
        // ç”ŸæˆåŠ¨æ€è·¯ç”±
        const accessRoutes = permissionStore.generateRoutes();
        accessRoutes.forEach(route => {
          router.addRoute(route);
        });
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šé‡æ–°å¯¼èˆªåˆ°ç›®æ ‡è·¯ç”±
        next({ ...to, replace: true });
        return;
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        // æ¸…é™¤tokenå¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
        authStore.logout();
        next('/login');
        return;
      }
    }
    
    // æ£€æŸ¥é¡µé¢æƒé™
    if (to.meta?.permissions && Array.isArray(to.meta.permissions) && to.meta.permissions.length > 0) {
      const hasPermission = permissionStore.hasAnyPermission(to.meta.permissions);
      if (!hasPermission) {
        next('/403');
        return;
      }
    }
    
    next();
  } else {
    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
    if (to.path !== '/login') {
      next('/login');
    } else {
      next();
    }
  }
});
```

#### next()å‡½æ•°çš„æ­£ç¡®ç”¨æ³•

```typescript
// 1. æ­£å¸¸é€šè¿‡
next();
// æ•ˆæœï¼šç»§ç»­å½“å‰çš„å¯¼èˆª

// 2. é‡å®šå‘åˆ°æ–°è·¯å¾„
next('/login');
// æ•ˆæœï¼šå–æ¶ˆå½“å‰å¯¼èˆªï¼Œè·³è½¬åˆ°æ–°è·¯å¾„

// 3. é‡æ–°å¯¼èˆªåˆ°å½“å‰è·¯å¾„ï¼ˆåˆ·æ–°ååŠ¨æ€è·¯ç”±æ·»åŠ çš„æƒ…å†µï¼‰
next({ ...to, replace: true });
// æ•ˆæœï¼šå–æ¶ˆå½“å‰å¯¼èˆªï¼Œé‡æ–°å¯¼èˆªåˆ°ç›®æ ‡è·¯å¾„
// replace: true é¿å…åœ¨å†å²è®°å½•ä¸­ç•™ä¸‹è®°å½•
```

### 2. å®Œå–„çŠ¶æ€æŒä¹…åŒ–

#### åœ¨Pinia storeä¸­å®ç°çŠ¶æ€æ¢å¤

```typescript
// auth.store.ts
export const useAuthStore = defineStore('auth', () => {
  const token = ref<string>('');
  const userInfo = ref<UserInfo | null>(null);
  
  // åˆå§‹åŒ–æ—¶ä»localStorageæ¢å¤çŠ¶æ€
  const initAuth = async () => {
    const savedToken = localStorage.getItem('token');
    if (savedToken) {
      token.value = savedToken;
      
      // å¦‚æœæœ‰tokenä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‡æ–°è·å–
      if (!userInfo.value) {
        try {
          const response = await getUserInfo();
          userInfo.value = response.data;
        } catch (error) {
          // tokenå¯èƒ½å·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
          logout();
          throw error;
        }
      }
    }
  };
  
  // ç™»å½•æˆåŠŸåä¿å­˜çŠ¶æ€
  const loginAction = async (loginData: LoginRequest) => {
    try {
      const response = await login(loginData);
      token.value = response.data.token;
      userInfo.value = response.data.userInfo;
      
      // æŒä¹…åŒ–åˆ°localStorage
      localStorage.setItem('token', token.value);
      return true;
    } catch (error) {
      return false;
    }
  };
  
  // ç™»å‡ºæ—¶æ¸…é™¤çŠ¶æ€
  const logout = () => {
    token.value = '';
    userInfo.value = null;
    localStorage.removeItem('token');
  };
  
  return {
    token,
    userInfo,
    initAuth,
    loginAction,
    logout
  };
});
```

### 3. å¤„ç†å¼‚æ­¥ç»„ä»¶åŠ è½½é—®é¢˜

#### ä½¿ç”¨Suspenseç»„ä»¶

```vue
<!-- App.vue -->
<template>
  <div id="app">
    <Suspense>
      <template #default>
        <router-view />
      </template>
      <template #fallback>
        <div class="loading">
          <el-loading-directive v-loading="true" text="åŠ è½½ä¸­..." />
        </div>
      </template>
    </Suspense>
  </div>
</template>
```

#### æ·»åŠ é”™è¯¯è¾¹ç•Œå¤„ç†

```vue
<!-- ErrorBoundary.vue -->
<template>
  <div v-if="hasError" class="error-boundary">
    <el-result
      icon="error"
      title="é¡µé¢åŠ è½½å¤±è´¥"
      sub-title="è¯·åˆ·æ–°é¡µé¢é‡è¯•"
    >
      <template #extra>
        <el-button type="primary" @click="reload">åˆ·æ–°é¡µé¢</el-button>
      </template>
    </el-result>
  </div>
  <slot v-else />
</template>

<script setup lang="ts">
import { ref, onErrorCaptured } from 'vue';

const hasError = ref(false);

onErrorCaptured((error) => {
  console.error('ç»„ä»¶æ¸²æŸ“é”™è¯¯:', error);
  hasError.value = true;
  return false;
});

const reload = () => {
  window.location.reload();
};
</script>
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. Nginxé…ç½®

```nginx
server {
  listen 80;
  server_name your-domain.com;
  root /path/to/your/dist;
  index index.html;

  # SPAè·¯ç”±å›é€€é…ç½®
  location / {
    try_files $uri $uri/ /index.html;
  }

  # APIè¯·æ±‚ä»£ç†
  location /api/ {
    proxy_pass http://your-backend-server:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # é™æ€èµ„æºç¼“å­˜
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
  }
}
```

### 2. Apacheé…ç½®

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

## è°ƒè¯•æ–¹æ³•

### 1. å¼€å‘ç¯å¢ƒè°ƒè¯•

```typescript
// åœ¨è·¯ç”±å®ˆå«ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
router.beforeEach(async (to, from, next) => {
  console.log('è·¯ç”±å®ˆå«è§¦å‘:', {
    to: to.path,
    from: from.path,
    hasToken: !!authStore.token,
    hasUserInfo: !!authStore.userInfo
  });
  
  // ... å…¶ä»–é€»è¾‘
});
```

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networké¢æ¿ä¸­æ£€æŸ¥ï¼š
- é¡µé¢åˆ·æ–°æ—¶æ˜¯å¦æ­£ç¡®è¿”å›äº† `index.html`
- APIè¯·æ±‚æ˜¯å¦æ­£å¸¸
- é™æ€èµ„æºæ˜¯å¦åŠ è½½æˆåŠŸ

### 3. çŠ¶æ€æ£€æŸ¥

```typescript
// åœ¨ç»„ä»¶ä¸­æ£€æŸ¥çŠ¶æ€
onMounted(() => {
  console.log('ç»„ä»¶æŒ‚è½½æ—¶çš„çŠ¶æ€:', {
    route: route.path,
    token: authStore.token,
    userInfo: authStore.userInfo,
    permissions: permissionStore.permissions
  });
});
```

## æœ€ä½³å®è·µæ€»ç»“

### 1. Viteé…ç½®
- âœ… ä½¿ç”¨Viteé»˜è®¤çš„SPAæ”¯æŒï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… æ­£ç¡®é…ç½®APIä»£ç†
- âŒ ä¸è¦ä½¿ç”¨ `historyApiFallback`ï¼ˆè¿™æ˜¯Webpacké…ç½®ï¼‰

### 2. è·¯ç”±å®ˆå«è®¾è®¡
- âœ… æ­£ç¡®å¤„ç†å¼‚æ­¥æƒé™åŠ è½½
- âœ… ä½¿ç”¨ `next({ ...to, replace: true })` é‡æ–°å¯¼èˆª
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 3. çŠ¶æ€ç®¡ç†
- âœ… å®ç°çŠ¶æ€æŒä¹…åŒ–
- âœ… é¡µé¢åˆ·æ–°æ—¶çš„çŠ¶æ€æ¢å¤
- âœ… é”™è¯¯è¾¹ç•Œå¤„ç†

### 4. ç”Ÿäº§éƒ¨ç½²
- âœ… é…ç½®WebæœåŠ¡å™¨çš„SPAè·¯ç”±å›é€€
- âœ… è®¾ç½®åˆé€‚çš„ç¼“å­˜ç­–ç•¥
- âœ… ç›‘æ§å’Œæ—¥å¿—è®°å½•

## æŠ€æœ¯æ ˆè¯´æ˜

- **Vite**: ç°ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼Œå†…ç½®SPAæ”¯æŒ
- **Vue Router**: Vue.jså®˜æ–¹è·¯ç”±ç®¡ç†å™¨ï¼Œæ”¯æŒHistoryæ¨¡å¼
- **History API**: æµè§ˆå™¨åŸç”ŸAPIï¼Œç”¨äºSPAè·¯ç”±
- **Pinia**: Vue.jsçŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒæŒä¹…åŒ–
- **TypeScript**: ç±»å‹å®‰å…¨çš„JavaScript

é€šè¿‡ä»¥ä¸Šæ­£ç¡®çš„é…ç½®å’Œå¤„ç†æ–¹å¼ï¼Œç¡®ä¿Vue SPAåº”ç”¨åœ¨ä»»ä½•è·¯å¾„ä¸‹åˆ·æ–°éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œæ— éœ€é”™è¯¯çš„ `historyApiFallback` é…ç½®ã€‚ 